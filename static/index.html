<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cohort Tracker Dashboard</title>
    <link rel="stylesheet" href="css/styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <!-- Class Selection Screen -->
    <div id="class-selection">
      <header>
        <h1>Cohort Tracker Dashboard</h1>
        <p style="opacity: 0.9; font-size: 0.95rem">Select a class to view</p>
      </header>
      <div class="class-grid" id="class-grid">
        <div
          class="loading"
          style="grid-column: 1/-1; text-align: center; padding: 40px"
        >
          Loading classes...
        </div>
      </div>
      <div class="show-archived">
        <label>
          <input
            type="checkbox"
            id="show-archived"
            onchange="toggleArchivedClasses()"
          />
          Show inactive classes
        </label>
        <label style="margin-left: 20px;">
          <input
            type="checkbox"
            id="demo-mode"
            onchange="toggleDemoMode()"
            checked
          />
          Demo Mode (mask names/emails)
        </label>
      </div>
    </div>

    <!-- Dashboard (hidden until class selected) -->
    <div id="dashboard">
      <header>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <div style="display: flex; align-items: center; gap: 20px;">
            <button class="back-button" onclick="backToClasses()" style="margin: 0; padding: 8px 16px; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
              ← Back to Classes
            </button>
            <h1 id="class-name" style="margin: 0;">Cohort Tracker Dashboard</h1>
          </div>
          <div style="display: flex; align-items: center; gap: 20px;">
            <label style="cursor: pointer; font-size: 0.9rem; color: white; display: flex; align-items: center; gap: 8px;">
              <input
                type="checkbox"
                id="demo-mode-dashboard"
                onchange="toggleDemoMode()"
                checked
              />
              Demo Mode
            </label>
            <div id="night-filter-container" style="display: none;">
              <label style="font-size: 0.9rem; color: white;">
                Filter by Night:
                <select id="global-night-filter" onchange="applyNightFilter()" style="margin-left: 10px; padding: 5px 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; cursor: pointer;">
                  <option value="">All Nights</option>
                </select>
              </label>
            </div>
          </div>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <p id="sync-info" class="last-sync" style="margin: 0;">Loading...</p>
          <div id="night-filter-message" style="display: none; font-size: 0.85rem; color: rgba(255,255,255,0.8); font-style: italic;">
            No night data available. Configure student nights via CLI: <code style="background: rgba(0,0,0,0.2); padding: 2px 6px; border-radius: 3px;">cargo run -- import-nights</code>
          </div>
        </div>
      </header>

      <div class="container">
        <div class="stats-grid" id="stats-grid">
          <div class="stat-card">
            <div class="value" id="stat-students">-</div>
            <div class="label">Students</div>
          </div>
          <div class="stat-card">
            <div class="value" id="stat-assignments">-</div>
            <div class="label">Assignments</div>
          </div>
          <div class="stat-card">
            <div class="value" id="stat-progressions">-</div>
            <div class="label">Progressions</div>
          </div>
          <div class="stat-card success">
            <div class="value" id="stat-completion">-</div>
            <div class="label">Completion Rate</div>
          </div>
          <div class="stat-card success">
            <div class="value" id="stat-avg-grade">-</div>
            <div class="label">Avg Grade</div>
          </div>
        </div>

        <div id="engagement-gap-alert" style="display: none; background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin-bottom: 20px; border-radius: 8px;">
          <h3 style="margin: 0 0 10px 0; color: #856404; font-size: 1.1rem;">⚠️ Engagement Gaps Detected</h3>
          <p style="margin: 0 0 10px 0; color: #856404; font-size: 0.9rem;">
            These students are on track (>50% complete) but haven't been active in 7-14 days. Early check-in recommended.
          </p>
          <div id="engagement-gap-list"></div>
        </div>

        <div class="grid-2">
          <div class="section">
            <h2>Most Difficult Assignments</h2>
            <p style="color: #666; font-size: 0.9rem; margin-bottom: 15px">
              Assignments ranked by difficulty score (completion rate + grade). Higher score = needs curriculum attention.
            </p>
            <table id="difficulty-table">
              <thead>
                <tr>
                  <th>Section</th>
                  <th>Assignment</th>
                  <th>Type</th>
                  <th>Difficulty</th>
                  <th>Completion</th>
                  <th>Avg Grade</th>
                </tr>
              </thead>
              <tbody id="difficulty-body">
                <tr>
                  <td colspan="6" class="loading">Loading...</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="section">
            <h2>Students at Risk</h2>
            <p style="color: #666; font-size: 0.9rem; margin-bottom: 15px">
              Students who may need additional support. Click a row to view details.
            </p>
            <table id="risk-table">
              <thead>
                <tr>
                  <th>Student</th>
                  <th>Progress</th>
                  <th>Risk</th>
                </tr>
              </thead>
              <tbody id="risk-body">
                <tr>
                  <td colspan="3" class="loading">Loading...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="section">
          <h2>Student Activity</h2>
          <p style="color: #666; font-size: 0.9rem; margin-bottom: 15px">
            Last activity date for each student (sorted by least recent). Click a row to view details.
          </p>
          <div class="filters">
            <input
              type="text"
              id="student-search"
              placeholder="Search student..."
              oninput="filterStudentTable()"
            />
          </div>
          <table id="activity-table">
            <thead>
              <tr>
                <th>Student</th>
                <th>Night</th>
                <th>Progress</th>
                <th>Last Activity</th>
                <th>Days Inactive</th>
              </tr>
            </thead>
            <tbody id="activity-body">
              <tr>
                <td colspan="6" class="loading">Loading...</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Student Detail Modal -->
        <div id="student-modal" class="modal" style="display: none">
          <div class="modal-content">
            <div class="modal-header">
              <h2 id="modal-student-name">Student Details</h2>
              <button class="modal-close" onclick="closeStudentModal()">
                &times;
              </button>
            </div>
            <div id="modal-student-info" class="modal-info"></div>
            <div class="modal-stats" id="modal-stats"></div>
            <div class="modal-section">
              <h3>Progress Over Time</h3>
              <div class="chart-container" style="height: 200px">
                <canvas id="student-progress-chart"></canvas>
              </div>
            </div>
            <div class="modal-section">
              <h3>Activity by Day of Week</h3>
              <div class="chart-container" style="height: 200px">
                <canvas id="student-day-chart"></canvas>
              </div>
            </div>
            <div class="modal-section">
              <h3>Activity by Time of Day</h3>
              <div class="chart-container" style="height: 200px">
                <canvas id="student-time-chart"></canvas>
              </div>
            </div>
            <div class="modal-section">
              <h3>Problem Areas</h3>
              <div id="problem-areas"></div>
            </div>
            <div class="modal-section">
              <h3>All Assignments</h3>
              <table id="student-assignments-table">
                <thead>
                  <tr>
                    <th>Section</th>
                    <th>Assignment</th>
                    <th>Type</th>
                    <th>Status</th>
                    <th>Grade</th>
                    <th>Completed</th>
                  </tr>
                </thead>
                <tbody id="assignment-list"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Week Detail Modal -->
        <div id="week-modal" class="modal" style="display: none">
          <div class="modal-content">
            <div class="modal-header">
              <h2 id="modal-week-name">Week Details</h2>
              <button class="modal-close" onclick="closeWeekModal()">&times;</button>
            </div>
            <div id="modal-week-info" class="modal-info"></div>
            <div class="modal-section">
              <h3>Assignments Completed This Week</h3>
              <table id="week-assignments-table">
                <thead>
                  <tr>
                    <th>Section</th>
                    <th>Assignment</th>
                    <th>Completions</th>
                  </tr>
                </thead>
                <tbody id="week-assignments-body"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Section Detail Modal -->
        <div id="section-modal" class="modal" style="display: none">
          <div class="modal-content">
            <div class="modal-header">
              <h2 id="modal-section-name">Section Details</h2>
              <button class="modal-close" onclick="closeSectionModal()">&times;</button>
            </div>
            <div id="modal-section-info" class="modal-info"></div>
            <div class="modal-section">
              <h3>Students Not Started</h3>
              <p style="color: #666; font-size: 0.85rem; margin-bottom: 10px; font-style: italic;">
                Click a student to view their individual progress
              </p>
              <table id="section-not-started-table">
                <thead>
                  <tr>
                    <th>Student</th>
                    <th>Night</th>
                  </tr>
                </thead>
                <tbody id="section-not-started-body"></tbody>
              </table>
            </div>
            <div class="modal-section">
              <h3>Students In Progress</h3>
              <p style="color: #666; font-size: 0.85rem; margin-bottom: 10px; font-style: italic;">
                Click a student to view their individual progress
              </p>
              <table id="section-in-progress-table">
                <thead>
                  <tr>
                    <th>Student</th>
                    <th>Night</th>
                    <th>Progress</th>
                  </tr>
                </thead>
                <tbody id="section-in-progress-body"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Assignment Detail Modal -->
        <div id="assignment-modal" class="modal" style="display: none">
          <div class="modal-content">
            <div class="modal-header">
              <h2 id="modal-assignment-name">Assignment Details</h2>
              <button class="modal-close" onclick="closeAssignmentModal()">
                &times;
              </button>
            </div>
            <div id="modal-assignment-info" class="modal-info"></div>
            <div class="modal-section">
              <h3>Student Completion Status</h3>
              <table id="assignment-students-table">
                <thead>
                  <tr>
                    <th>Student</th>
                    <th>Status</th>
                    <th>Grade</th>
                    <th>Completed</th>
                  </tr>
                </thead>
                <tbody id="assignment-students-body"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="section">
          <h2>Performance by Night</h2>
          <p style="color: #666; font-size: 0.9rem; margin-bottom: 15px">
            Comparison of student progress across different cohort nights
          </p>
          <div id="night-summary-container">
            <div class="loading">Loading...</div>
          </div>
        </div>

        <div class="section">
          <h2>Progress Over Time</h2>
          <p style="color: #666; font-size: 0.9rem; margin-bottom: 15px">
            Weekly completion trends. Click a bar to see assignments completed that week.
          </p>
          <div class="chart-container">
            <canvas id="progress-chart"></canvas>
          </div>
        </div>

        <div class="section">
          <h2>Student Velocity (Pace)</h2>
          <p style="color: #666; font-size: 0.9rem; margin-bottom: 15px">
            Average assignments completed per student per week. Helps identify if the class is speeding up or slowing down.
          </p>
          <div class="chart-container">
            <canvas id="velocity-chart"></canvas>
          </div>
        </div>

        <div class="section">
          <h2>Performance by Assignment Type</h2>
          <p style="color: #666; font-size: 0.9rem; margin-bottom: 15px">
            Completion rates and grades by assignment type (lesson, quiz, etc.)
          </p>
          <table id="assignment-type-table">
            <thead>
              <tr>
                <th>Type</th>
                <th>Count</th>
                <th>Completion Rate</th>
                <th>Avg Grade</th>
              </tr>
            </thead>
            <tbody id="assignment-type-body">
              <tr><td colspan="4" class="loading">Loading...</td></tr>
            </tbody>
          </table>
        </div>

        <div class="section">
          <h2>Grade Distribution</h2>
          <p style="color: #666; font-size: 0.9rem; margin-bottom: 15px">
            Distribution of grades across all completed assignments
          </p>
          <div class="chart-container" style="height: 250px">
            <canvas id="grade-distribution-chart"></canvas>
          </div>
        </div>

        <div class="section">
          <h2>Activity by Day of Week</h2>
          <p style="color: #666; font-size: 0.9rem; margin-bottom: 15px">
            When students complete assignments
          </p>
          <div class="chart-container">
            <canvas id="day-of-week-chart"></canvas>
          </div>
        </div>

        <div class="section">
          <h2>Activity by Time of Day</h2>
          <p style="color: #666; font-size: 0.9rem; margin-bottom: 15px">
            What time students are completing work
          </p>
          <div class="chart-container">
            <canvas id="time-of-day-chart"></canvas>
          </div>
        </div>

        <div class="section">
          <h2>Progress by Section/Week</h2>
          <p style="color: #666; font-size: 0.9rem; margin-bottom: 15px">
            Student distribution across course sections. Click a row to see students not started or in progress.
          </p>
          <table id="section-progress-table">
            <thead>
              <tr>
                <th>Section</th>
                <th>Students Started</th>
                <th>Students Completed</th>
                <th>Completion Rate</th>
              </tr>
            </thead>
            <tbody id="section-progress-body">
              <tr><td colspan="4" class="loading">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <script src="js/app.js"></script>
  </body>
</html>
